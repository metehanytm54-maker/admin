<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş Yönetimi - Ada Sineklik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .nav-link {
            transition: all 0.2s ease-in-out;
            border-left: 4px solid transparent;
        }
        .nav-link:hover {
            background: rgba(51, 65, 85, 0.4);
            border-left: 4px solid #3b82f6;
            color: white !important;
        }
        .nav-link.active {
            background: #2563eb;
            color: white !important;
            border-left: 4px solid #60a5fa;
            font-weight: 700;
        }
        .modal-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); }
    </style>
    <script>
        if (sessionStorage.getItem("adminGiris") !== "true") {
            window.location.href = "login.html";
        }
    </script>
</head>
<body class="bg-slate-50 flex flex-col md:flex-row min-h-screen">

    <div class="w-full md:w-72 bg-slate-950 text-slate-300 md:fixed md:h-full z-50 flex flex-col shadow-2xl border-r border-slate-800">
        <div class="p-8 text-2xl font-extrabold text-white border-b border-slate-800 italic uppercase tracking-tighter flex justify-between items-center">
            <span><i class="fas fa-bolt text-yellow-400 mr-2"></i> ADA <span class="text-blue-500">ADMİN</span></span>
            <button class="md:hidden text-slate-400" onclick="document.getElementById('mobile-nav').classList.toggle('hidden')">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
        
        <nav id="mobile-nav" class="hidden md:block flex-1 mt-4 overflow-y-auto custom-scrollbar">
            <a href="admin_paneli.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-chart-pie w-8 text-lg text-blue-400"></i> Panel Özeti
            </a>
            <a href="admin_siparisler.html" class="nav-link active flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-shopping-basket w-8 text-lg text-emerald-400"></i> Sipariş Yönetimi
            </a>
            <a href="admin_musteriler.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400 border-b border-slate-900">
                <i class="fas fa-user-friends w-8 text-lg text-indigo-400"></i> Müşteri Portföyü
            </a>
            <a href="admin_imalat_endeks.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-ruler-combined w-8 text-lg text-orange-400"></i> İmalat Formülleri
            </a>
            <a href="admin_maliyet_endeks.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400 border-b border-slate-900">
                <i class="fas fa-coins w-8 text-lg text-yellow-500"></i> Maliyet Analizi
            </a>
            <a href="admin_urunler.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-layer-group w-8 text-lg text-rose-400"></i> Ürün Katalogu
            </a>
            <a href="Ham_malzeme_stok.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-warehouse w-8 text-lg text-cyan-400"></i> Hammadde Stok
            </a>
            <a href="admin_ayarlar.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-sliders-h w-8 text-lg text-slate-500"></i> Sistem Ayarları
            </a>

            <div class="mt-10 px-6">
                <button onclick="cikisYap()" class="w-full flex items-center justify-center py-3 px-4 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white transition-all rounded-xl text-xs font-bold uppercase tracking-widest border border-red-500/20">
                    <i class="fas fa-power-off mr-3"></i> Güvenli Çıkış
                </button>
            </div>
        </nav>
    </div>

    <div class="flex-1 md:ml-72 p-6 md:p-12">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
            <div>
                <h1 class="text-5xl font-black text-slate-900 tracking-tighter uppercase italic">
                    SİPARİŞ <span class="text-blue-600">YÖNETİMİ</span>
                </h1>
                <p class="text-slate-500 font-medium mt-2" id="toplamSiparis">Veriler yükleniyor...</p>
            </div>
            <div class="flex flex-wrap gap-3">
                <button onclick="location.href='fiyatlandırma.html'" class="bg-indigo-600 text-white px-6 py-3 rounded-2xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 flex items-center gap-2">
                    <i class="fas fa-tags"></i> FİYATLANDIRMA
                </button>
                <button onclick="location.href='admin_siparis_olustur.html'" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200 flex items-center gap-2">
                    <i class="fas fa-plus"></i> YENİ SİPARİŞ
                </button>
            </div>
        </header>

        <div id="siparisKonteyner" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="col-span-full text-center py-20">
                <i class="fas fa-circle-notch fa-spin fa-3x text-blue-500"></i>
                <p class="mt-4 text-slate-400 font-medium tracking-widest uppercase text-xs">Siparişler Getiriliyor</p>
            </div>
        </div>
    </div>

    <div id="islemModal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-md shadow-2xl border border-slate-100">
            <h2 class="text-2xl font-black mb-8 text-slate-900 flex items-center gap-3 uppercase italic">
                <i class="fas fa-pen-nib text-blue-500"></i> SİPARİŞİ GÜNCELLE
            </h2>
            <input type="hidden" id="modalSiparisId">
            
            <div class="space-y-6">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Sipariş Durumu</label>
                    <select id="modalDurum" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-blue-500 font-bold bg-slate-50 text-slate-700 mt-1">
                        <option value="Yeni Sipariş">Yeni Sipariş</option>
                        <option value="Ölçü Onaylandı">Ölçü Onaylandı</option>
                        <option value="Hazırlanıyor">Hazırlanıyor</option>
                        <option value="Montaj Bekliyor">Montaj Bekliyor</option>
                        <option value="Tamamlandı">Tamamlandı</option>
                        <option value="İptal Edildi">İptal Edildi</option>
                    </select>
                </div>

                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Toplam Satış Tutarı (₺)</label>
                    <input type="number" id="modalFiyat" placeholder="0.00" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-emerald-500 font-black text-2xl text-emerald-600 bg-slate-50 mt-1">
                </div>

                <div class="flex gap-4 pt-6">
                    <button onclick="siparisGuncelle()" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black hover:bg-blue-600 shadow-xl uppercase transition tracking-tighter">Değişiklikleri Kaydet</button>
                    <button onclick="modalKapat()" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold hover:bg-slate-200 transition uppercase text-xs">Vazgeç</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4yp1I0chuf2j_emvMUiGqWXoo9x-PxgY",
            authDomain: "adasineklik54-148c1.firebaseapp.com",
            projectId: "adasineklik54-148c1",
            storageBucket: "adasineklik54-148c1.firebasestorage.app",
            messagingSenderId: "203700124554",
            appId: "1:203700124554:web:049b5df50866a795dba673"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const q = query(collection(db, "siparisler"), orderBy("tarih", "desc"));
        
        onSnapshot(q, (snapshot) => {
            const container = document.getElementById('siparisKonteyner');
            document.getElementById('toplamSiparis').innerText = `Şu anda sistemde ${snapshot.size} aktif sipariş bulunuyor.`;
            container.innerHTML = "";

            if (snapshot.empty) {
                container.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400 font-bold bg-white rounded-[3rem] border-4 border-dashed border-slate-100">Henüz hiç sipariş alınmamış.</div>`;
                return;
            }

            snapshot.forEach(res => {
                const s = res.data();
                const id = res.id;
                const tarih = s.tarih ? new Date(s.tarih).toLocaleDateString('tr-TR', {day:'numeric', month:'long', year:'numeric'}) : '-';
                
                let renkClass = "bg-slate-100 text-slate-600";
                if(s.durum === "Yeni Sipariş") renkClass = "bg-blue-500 text-white";
                if(s.durum === "Hazırlanıyor") renkClass = "bg-amber-500 text-white";
                if(s.durum === "Tamamlandı") renkClass = "bg-emerald-500 text-white";
                if(s.durum === "İptal Edildi") renkClass = "bg-red-500 text-white";

                container.innerHTML += `
                    <div class="bg-white rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-50 p-8 flex flex-col justify-between hover:scale-[1.02] transition-transform duration-300 relative overflow-hidden">
                        <div>
                            <div class="flex justify-between items-start mb-6">
                                <span class="px-4 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest ${renkClass}">
                                    ${s.durum}
                                </span>
                                <button onclick="siparisSil('${id}')" class="w-10 h-10 rounded-xl bg-red-50 text-red-400 hover:bg-red-500 hover:text-white transition flex items-center justify-center"><i class="fas fa-trash-alt text-sm"></i></button>
                            </div>
                            
                            <h3 class="text-2xl font-black text-slate-800 uppercase italic tracking-tighter mb-1">${s.musteri}</h3>
                            <p class="text-[11px] text-slate-400 font-bold uppercase tracking-widest mb-6"><i class="far fa-calendar-alt mr-1 text-blue-500"></i> ${tarih}</p>
                            
                            <div class="bg-slate-50 rounded-3xl p-5 mb-6 border border-slate-100">
                                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Sipariş Detayları</p>
                                <div class="space-y-3">
                                    ${s.kalemler.map(k => `
                                        <div class="flex justify-between items-center border-b border-slate-200/50 pb-2 last:border-0 last:pb-0">
                                            <span class="text-slate-700 font-bold text-sm">${k.adet}x ${k.tanim}</span>
                                            <span class="text-blue-600 text-xs font-black bg-blue-50 px-2 py-1 rounded-lg">${k.en}x${k.boy}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>

                        <div class="pt-4 border-t border-slate-100">
                            <div class="flex justify-between items-end">
                                <div>
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Tahsil Edilecek</p>
                                    <p class="text-2xl font-black text-slate-900 italic">${s.fiyat ? s.fiyat + ' ₺' : '<span class="text-sm text-amber-500 uppercase">Fiyat Belirlenmedi</span>'}</p>
                                </div>
                                <div class="flex flex-col gap-2">
                                     <button onclick="location.href='admin_imalat_listesi_olustur.html?siparisId=${id}'" 
                                        class="bg-orange-100 text-orange-600 px-4 py-2 rounded-xl text-[10px] font-black hover:bg-orange-600 hover:text-white transition uppercase tracking-tighter">
                                        İmalat Kartı
                                    </button>
                                    <button onclick="islemModalAc('${id}', '${s.durum}', '${s.fiyat || ''}')" 
                                        class="bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black hover:bg-blue-600 transition shadow-lg uppercase tracking-tighter">
                                        Yönet
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
        });

        window.islemModalAc = (id, durum, fiyat) => {
            document.getElementById('islemModal').classList.remove('hidden');
            document.getElementById('modalSiparisId').value = id;
            document.getElementById('modalDurum').value = durum;
            document.getElementById('modalFiyat').value = fiyat;
        };

        window.modalKapat = () => document.getElementById('islemModal').classList.add('hidden');

        window.siparisGuncelle = async () => {
            const id = document.getElementById('modalSiparisId').value;
            const yeniDurum = document.getElementById('modalDurum').value;
            const yeniFiyat = document.getElementById('modalFiyat').value;

            try {
                const { doc, updateDoc, getFirestore } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const db = getFirestore();
                await updateDoc(doc(db, "siparisler", id), {
                    durum: yeniDurum,
                    fiyat: yeniFiyat
                });
                modalKapat();
            } catch (e) { alert("Hata: " + e.message); }
        };

        window.siparisSil = async (id) => {
            if(confirm("Bu sipariş kalıcı olarak silinecektir. Onaylıyor musunuz?")) {
                try {
                    const { doc, deleteDoc, getFirestore } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const db = getFirestore();
                    await deleteDoc(doc(db, "siparisler", id));
                } catch (e) { alert("Silme hatası!"); }
            }
        };

        window.cikisYap = () => {
            if(confirm("Güvenli çıkış yapılsın mı?")) {
                sessionStorage.removeItem("adminGiris");
                window.location.href = "login.html";
            }
        };
    </script>
</body>
</html>