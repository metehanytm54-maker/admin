<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ürün Kataloğu - Ada Sineklik</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .nav-link {
            transition: all 0.2s ease-in-out;
            border-left: 4px solid transparent;
        }
        .nav-link:hover {
            background: rgba(51, 65, 85, 0.4);
            border-left: 4px solid #3b82f6;
            color: white !important;
        }
        .nav-link.active {
            background: #2563eb;
            color: white !important;
            border-left: 4px solid #60a5fa;
            font-weight: 700;
        }
        .modal-overlay { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(8px); }
        .dynamic-row { animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }
    </style>
    <script>
        if (sessionStorage.getItem("adminGiris") !== "true") {
            window.location.href = "login.html";
        }
    </script>
</head>
<body class="bg-slate-50 flex flex-col md:flex-row min-h-screen">

    <div class="w-full md:w-72 bg-slate-950 text-slate-300 md:fixed md:h-full z-50 flex flex-col shadow-2xl border-r border-slate-800">
        <div class="p-8 text-2xl font-extrabold text-white border-b border-slate-800 italic uppercase tracking-tighter flex justify-between items-center">
            <span><i class="fas fa-bolt text-yellow-400 mr-2"></i> ADA <span class="text-blue-500">ADMİN</span></span>
            <button class="md:hidden text-slate-400" onclick="document.getElementById('mobile-nav').classList.toggle('hidden')">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
        
        <nav id="mobile-nav" class="hidden md:block flex-1 mt-4 overflow-y-auto custom-scrollbar">
            <a href="admin_paneli.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-chart-pie w-8 text-lg text-blue-400"></i> Panel Özeti
            </a>
            <a href="admin_siparisler.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-shopping-basket w-8 text-lg text-emerald-400"></i> Sipariş Yönetimi
            </a>
            <a href="admin_musteriler.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400 border-b border-slate-900">
                <i class="fas fa-user-friends w-8 text-lg text-indigo-400"></i> Müşteri Portföyü
            </a>
            <a href="admin_imalat_endeks.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-ruler-combined w-8 text-lg text-orange-400"></i> İmalat Formülleri
            </a>
            <a href="admin_maliyet_endeks.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400 border-b border-slate-900">
                <i class="fas fa-coins w-8 text-lg text-yellow-500"></i> Maliyet Analizi
            </a>
            <a href="admin_urunler.html" class="nav-link active flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-layer-group w-8 text-lg text-rose-400"></i> Ürün Kataloğu
            </a>
            <a href="Ham_malzeme_stok.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-warehouse w-8 text-lg text-cyan-400"></i> Hammadde Stok
            </a>
            <a href="admin_ayarlar.html" class="nav-link flex items-center py-4 px-6 mb-1 text-slate-400">
                <i class="fas fa-sliders-h w-8 text-lg text-slate-500"></i> Sistem Ayarları
            </a>

            <div class="mt-10 px-6 mb-6">
                <button onclick="cikisYap()" class="w-full flex items-center justify-center py-3 px-4 bg-red-500/10 hover:bg-red-500 text-red-500 hover:text-white transition-all rounded-xl text-xs font-bold uppercase tracking-widest border border-red-500/20">
                    <i class="fas fa-power-off mr-3"></i> Güvenli Çıkış
                </button>
            </div>
        </nav>
    </div>

    <div class="flex-1 md:ml-72 p-6 md:p-12">
        
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
            <div>
                <h1 class="text-5xl font-black text-slate-900 tracking-tighter uppercase italic">
                    ÜRÜN <span class="text-rose-500">KATALOĞU</span>
                </h1>
                <p class="text-slate-500 font-medium mt-2">Dinamik özelliklerle ürünlerinizi yönetin.</p>
            </div>
            <div class="flex gap-3">
                <button onclick="modalAc()" class="bg-rose-500 text-white px-6 py-3 rounded-2xl font-bold hover:bg-rose-600 transition shadow-lg shadow-rose-200 flex items-center gap-2">
                    <i class="fas fa-plus"></i> YENİ ÜRÜN EKLE
                </button>
            </div>
        </header>

        <div id="urunListesi" class="grid grid-cols-1 xl:grid-cols-2 gap-8">
            <div class="col-span-full text-center py-20">
                <i class="fas fa-circle-notch fa-spin fa-3x text-rose-500"></i>
                <p class="mt-4 text-slate-400 font-medium tracking-widest uppercase text-xs">Ürünler Getiriliyor</p>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 z-[100] modal-overlay flex items-center justify-center p-4">
        <div class="bg-white rounded-[2.5rem] p-10 w-full max-w-2xl shadow-2xl border border-slate-100 overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-8">
                <h2 id="modalTitle" class="text-2xl font-black text-slate-900 flex items-center gap-3 uppercase italic">
                    <i class="fas fa-box-open text-rose-500"></i> ÜRÜN KAYDI
                </h2>
                <button onclick="ozellikSatiriEkle()" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl text-xs font-black hover:bg-blue-600 hover:text-white transition uppercase tracking-widest">
                    <i class="fas fa-plus mr-1"></i> ÖZELLİK EKLE
                </button>
            </div>
            
            <input type="hidden" id="editId">
            
            <div id="dinamikFormKonteyner" class="space-y-4 mb-8">
                </div>

            <div class="space-y-6 pt-6 border-t border-slate-100">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Ürün Görsel URL</label>
                    <input type="text" id="resim" placeholder="https://..." class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-rose-500 font-medium bg-slate-50 mt-1">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Genişlik (PX)</label>
                        <input type="number" id="imgW" value="300" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-slate-400 font-bold bg-slate-50 mt-1">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Yükseklik (PX)</label>
                        <input type="number" id="imgH" value="157" class="w-full border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-slate-400 font-bold bg-slate-50 mt-1">
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button onclick="urunKaydet()" class="flex-1 bg-slate-900 text-white py-4 rounded-2xl font-black hover:bg-rose-600 shadow-xl uppercase transition tracking-tighter">Değişiklikleri Kaydet</button>
                    <button onclick="modalKapat()" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-bold hover:bg-slate-200 transition uppercase text-xs">Vazgeç</button>
                </div>
            </div>
        </div>
    </div>

    <div id="imgModal" class="hidden fixed inset-0 z-[110] modal-overlay flex items-center justify-center p-4 cursor-pointer" onclick="this.classList.add('hidden')">
        <img id="fullImage" src="" class="max-w-full max-h-[85vh] rounded-[2rem] shadow-2xl border-8 border-white">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4yp1I0chuf2j_emvMUiGqWXoo9x-PxgY",
            authDomain: "adasineklik54-148c1.firebaseapp.com",
            projectId: "adasineklik54-148c1",
            storageBucket: "adasineklik54-148c1.firebasestorage.app",
            messagingSenderId: "203700124554",
            appId: "1:203700124554:web:049b5df50866a795dba673"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let ayarlarKutuphanesi = {}; 
        let localUrunler = {};

        // 1. AYARLARI KÜTÜPHANEYE ÇEK
        onSnapshot(collection(db, "ayarlar"), (snapshot) => {
            ayarlarKutuphanesi = {};
            snapshot.forEach(res => {
                const data = res.data();
                ayarlarKutuphanesi[data.baslik] = data.liste;
            });
        });

        // 2. DİNAMİK ÖZELLİK SATIRI EKLEME
        window.ozellikSatiriEkle = (varsayilanBaslik = "", varsayilanDeger = "") => {
            const container = document.getElementById('dinamikFormKonteyner');
            const rowId = "row_" + Date.now() + Math.random().toString(36).substr(2, 5);
            
            const div = document.createElement('div');
            div.id = rowId;
            div.className = "dynamic-row grid grid-cols-2 gap-4 bg-slate-50 p-4 rounded-2xl border border-slate-100 relative group";
            
            div.innerHTML = `
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Özellik</label>
                    <input type="text" placeholder="Örn: Renk" value="${varsayilanBaslik}" 
                        oninput="listeGuncelle('${rowId}', this.value)" 
                        class="baslik-input w-full border-2 border-white p-3 rounded-xl outline-none focus:border-blue-400 text-sm font-bold bg-white">
                </div>
                <div class="space-y-1">
                    <label class="text-[9px] font-black text-slate-400 uppercase tracking-widest">Seçenek</label>
                    <div id="select_container_${rowId}">
                        <input type="text" placeholder="..." value="${varsayilanDeger}" class="deger-input w-full border-2 border-white p-3 rounded-xl outline-none text-sm bg-white">
                    </div>
                </div>
                <button onclick="document.getElementById('${rowId}').remove()" class="absolute -right-2 -top-2 bg-red-500 text-white w-7 h-7 rounded-full text-xs opacity-0 group-hover:opacity-100 transition shadow-lg flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
            if(varsayilanBaslik) window.listeGuncelle(rowId, varsayilanBaslik, varsayilanDeger);
        };

        // 3. BAŞLIK YAZILDIĞINDA AYARLARLA EŞLEŞTİRME
        window.listeGuncelle = (rowId, baslik, seciliDeger = "") => {
            const container = document.getElementById(`select_container_${rowId}`);
            if (ayarlarKutuphanesi[baslik]) {
                const liste = ayarlarKutuphanesi[baslik];
                container.innerHTML = `
                    <select class="deger-input w-full border-2 border-white p-3 rounded-xl outline-none bg-white text-sm font-black text-blue-600">
                        <option value="">Seçin...</option>
                        ${liste.map(item => `<option value="${item}" ${item === seciliDeger ? 'selected' : ''}>${item}</option>`).join('')}
                    </select>
                `;
            } else {
                container.innerHTML = `<input type="text" placeholder="Manuel değer..." value="${seciliDeger}" class="deger-input w-full border-2 border-white p-3 rounded-xl outline-none text-sm bg-white">`;
            }
        };

        // 4. ÜRÜNLERİ LİSTELE
        onSnapshot(collection(db, "urunler"), (snapshot) => {
            const list = document.getElementById('urunListesi');
            list.innerHTML = "";
            localUrunler = {};

            if (snapshot.empty) {
                list.innerHTML = `<div class="col-span-full text-center py-20 text-slate-400 font-bold bg-white rounded-[3rem] border-4 border-dashed border-slate-100 uppercase tracking-widest">Katalog Boş</div>`;
                return;
            }

            snapshot.forEach(res => {
                const u = res.data();
                const id = res.id;
                localUrunler[id] = u;

                let detayHTML = "";
                if(u.ozellikler) {
                    u.ozellikler.forEach(oz => {
                        detayHTML += `
                        <div class="flex justify-between items-center border-b border-slate-100 pb-2 last:border-0 last:pb-0">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${oz.baslik}</span>
                            <span class="text-slate-800 font-bold text-sm">${oz.deger}</span>
                        </div>`;
                    });
                }

                list.innerHTML += `
                    <div class="bg-white p-8 rounded-[2.5rem] shadow-xl shadow-slate-200/50 border border-slate-50 flex flex-col md:flex-row gap-8 hover:scale-[1.01] transition-transform duration-300">
                        <div class="flex-1 flex flex-col justify-between">
                            <div>
                                <h3 class="text-2xl font-black text-slate-900 uppercase italic tracking-tighter mb-6">
                                    ${u.ozellikler && u.ozellikler[0] ? u.ozellikler[0].deger : 'İsimsiz Ürün'}
                                </h3>
                                <div class="space-y-3 bg-slate-50 p-5 rounded-[2rem] border border-slate-100">
                                    ${detayHTML}
                                </div>
                            </div>
                            <div class="mt-8 flex gap-3">
                                <button onclick="modalAc('${id}')" class="flex-1 bg-slate-900 text-white px-4 py-3 rounded-xl text-[10px] font-black hover:bg-blue-600 transition shadow-lg uppercase tracking-widest">DÜZENLE</button>
                                <button onclick="urunSil('${id}')" class="bg-red-50 text-red-500 px-4 py-3 rounded-xl text-[10px] font-black hover:bg-red-500 hover:text-white transition uppercase tracking-widest">SİL</button>
                            </div>
                        </div>
                        <div class="relative group cursor-pointer rounded-[2rem] overflow-hidden border-4 border-slate-50 shadow-inner flex-shrink-0 mx-auto md:mx-0" 
                             onclick="resimBuyut('${u.resim}')" style="width:${u.w}px; height:${u.h}px;">
                            <img src="${u.resim}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-slate-900/40 flex items-center justify-center opacity-0 group-hover:opacity-100 transition duration-300">
                                <i class="fas fa-expand text-white text-3xl"></i>
                            </div>
                        </div>
                    </div>`;
            });
        });

        window.modalAc = (id = null) => {
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('dinamikFormKonteyner').innerHTML = "";
            
            if(id && localUrunler[id]) {
                const data = localUrunler[id];
                document.getElementById('editId').value = id;
                document.getElementById('resim').value = data.resim;
                document.getElementById('imgW').value = data.w;
                document.getElementById('imgH').value = data.h;
                if(data.ozellikler) {
                    data.ozellikler.forEach(oz => ozellikSatiriEkle(oz.baslik, oz.deger));
                }
            } else {
                document.getElementById('editId').value = "";
                document.getElementById('resim').value = "";
                ozellikSatiriEkle(); 
            }
        };

        window.modalKapat = () => document.getElementById('modal').classList.add('hidden');
        window.resimBuyut = (url) => { 
            document.getElementById('fullImage').src = url; 
            document.getElementById('imgModal').classList.remove('hidden'); 
        };

        window.urunKaydet = async () => {
            const id = document.getElementById('editId').value;
            const rows = document.querySelectorAll('.dynamic-row');
            const ozellikler = [];

            rows.forEach(row => {
                const b = row.querySelector('.baslik-input').value;
                const d = row.querySelector('.deger-input').value;
                if(b && d) ozellikler.push({ baslik: b, deger: d });
            });

            const payload = {
                ozellikler: ozellikler,
                resim: document.getElementById('resim').value,
                w: document.getElementById('imgW').value,
                h: document.getElementById('imgH').value,
                tarih: new Date().toISOString()
            };

            try {
                const { doc, updateDoc, addDoc, collection, getFirestore } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                const db = getFirestore();
                if(id) await updateDoc(doc(db, "urunler", id), payload);
                else await addDoc(collection(db, "urunler"), payload);
                modalKapat();
            } catch (e) { alert("Kaydetme hatası: " + e.message); }
        };

        window.urunSil = async (id) => { 
            if(confirm("Bu ürün katalogdan kalıcı olarak silinecektir. Onaylıyor musunuz?")) {
                try {
                    const { doc, deleteDoc, getFirestore } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                    const db = getFirestore();
                    await deleteDoc(doc(db, "urunler", id));
                } catch (e) { alert("Silme hatası!"); }
            }
        };

        window.cikisYap = () => {
            if(confirm("Güvenli çıkış yapılsın mı?")) {
                sessionStorage.removeItem("adminGiris");
                window.location.href = "login.html";
            }
        };
    </script>
</body>
</html>